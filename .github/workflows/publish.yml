name: ä¸­æ–‡æäº¤è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    branches:
      - main  # ä½ å¯ä»¥æ”¹ä¸ºä½ çš„ä¸»åˆ†æ”¯å

jobs:
  analyze-commit-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          fetch-tags: true

      - name: åˆ†ææœ€è¿‘æäº¤
        id: analyze-commits
        run: |
          # è·å–æœ€è¿‘çš„æœ‰æ•ˆæäº¤ï¼ˆè·³è¿‡è‹±æ–‡updateæäº¤ï¼‰
          echo "æ­£åœ¨åˆ†ææäº¤è®°å½•..."
          
          # è·å–æœ€è¿‘çš„ä¸¤ä¸ªæäº¤
          COMMITS=$(git log --oneline --no-merges -10)
          echo "æœ€è¿‘æäº¤:"
          echo "$COMMITS"
          echo ""
          
          # è¿‡æ»¤æ‰è‹±æ–‡updateæäº¤ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªæœ‰æ•ˆçš„ä¸­æ–‡æäº¤
          LAST_VALID_COMMIT=""
          LAST_VALID_COMMIT_FULL=""
          IFS=$'\n'
          for commit in $(git log --format="%H %s" --no-merges -5); do
            COMMIT_HASH=$(echo $commit | cut -d' ' -f1)
            COMMIT_MSG=$(echo $commit | cut -d' ' -f2-)
            
            # è·³è¿‡è‹±æ–‡updateæäº¤
            if [[ "$COMMIT_MSG" =~ ^(update|Update|UPDATE|fix|Fix|FIX|ä¿®æ”¹|è°ƒæ•´).* ]] && \
               [[ ! "$COMMIT_MSG" =~ [\u4e00-\u9fff] ]]; then  # ä¸åŒ…å«ä¸­æ–‡
              echo "è·³è¿‡è‹±æ–‡updateæäº¤: $COMMIT_MSG"
              continue
            fi
          
            # æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæäº¤å°±åœæ­¢
            LAST_VALID_COMMIT="$COMMIT_MSG"
            LAST_VALID_COMMIT_FULL=$(git log -1 --format="%H%n%s%n%b" $COMMIT_HASH)
            break
          done
          
          if [ -z "$LAST_VALID_COMMIT" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸­æ–‡æäº¤ï¼Œä½¿ç”¨æœ€æ–°çš„æäº¤"
            LAST_VALID_COMMIT=$(git log -1 --format="%s" --no-merges)
            LAST_VALID_COMMIT_FULL=$(git log -1 --format="%H%n%s%n%b" HEAD)
          fi
          
          echo "ä½¿ç”¨çš„æœ‰æ•ˆæäº¤: $LAST_VALID_COMMIT"
          
          # åˆ¤æ–­ç‰ˆæœ¬æ›´æ–°ç±»å‹
          VERSION_BUMP="patch"  # é»˜è®¤å°æ›´æ–°
          
          if [[ "$LAST_VALID_COMMIT" =~ "å¤§æ›´æ–°" ]]; then
            VERSION_BUMP="major"
            echo "æ£€æµ‹åˆ°å¤§æ”¹ï¼Œç‰ˆæœ¬é€’å¢ç±»å‹: major"
          elif [[ "$LAST_VALID_COMMIT" =~ "ä¹±æ”¹" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "ä¸å…¼å®¹" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "é‡å¤§å˜æ›´" ]]; then
            VERSION_BUMP="major"
            echo "æ£€æµ‹åˆ°ä¹±æ”¹ï¼Œç‰ˆæœ¬é€’å¢ç±»å‹: major"
          elif [[ "$LAST_VALID_COMMIT" =~ "åšäº†ä¸ª" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "å†™äº†ä¸ª" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "ä¸­æ›´æ–°" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "æ–°å¢" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "mid" ]]; then
            VERSION_BUMP="minor"
            echo "æ£€æµ‹åˆ°åŠŸèƒ½æ›´æ–°ï¼Œç‰ˆæœ¬é€’å¢ç±»å‹: minor"
          elif [[ "$LAST_VALID_COMMIT" =~ "ä¿®äº†ä¸ª" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "ä¿®å¤" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "å°æ›´æ–°" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "bug" ]] || \
               [[ "$LAST_VALID_COMMIT" =~ "Bug" ]]; then
            VERSION_BUMP="patch"
            echo "æ£€æµ‹åˆ°bugä¿®å¤ï¼Œç‰ˆæœ¬é€’å¢ç±»å‹: patch"
          else
            echo "ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬é€’å¢ç±»å‹: patch"
          fi
          
          # è¾“å‡ºç»“æœ
          echo "commit_message=$LAST_VALID_COMMIT" >> $GITHUB_OUTPUT
          echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT
          echo "commit_hash=$(echo "$LAST_VALID_COMMIT_FULL" | head -1)" >> $GITHUB_OUTPUT
          echo "commit_body=$(echo "$LAST_VALID_COMMIT_FULL" | tail -n +3 | head -10)" >> $GITHUB_OUTPUT

      - name: è·å–æˆ–åˆ›å»ºç‰ˆæœ¬å·
        id: version
        run: |
          # è·å–æœ€æ–°çš„æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "æœ€æ–°æ ‡ç­¾: $LATEST_TAG"
          
          # æå–ç‰ˆæœ¬å·
          CURRENT_VERSION="${LATEST_TAG#v}"
          if [ "$CURRENT_VERSION" = "0.0.0" ]; then
            # æ²¡æœ‰æ ‡ç­¾ï¼Œå°è¯•ä»package.jsonè¯»å–
            if [ -f "package.json" ]; then
              CURRENT_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "0.1.0")
            else
              CURRENT_VERSION="0.1.0"
            fi
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # é€’å¢ç‰ˆæœ¬
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          case "${{ steps.analyze-commits.outputs.version_bump }}" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # è¾“å‡ºå˜é‡
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: è·å–æœ€è¿‘çš„æ‰€æœ‰æœ‰æ•ˆæäº¤ï¼ˆç”¨äºReleaseè¯´æ˜ï¼‰
        id: all_commits
        run: |
          # è·å–æœ€è¿‘5ä¸ªæœ‰æ•ˆæäº¤ï¼ˆè·³è¿‡è‹±æ–‡updateï¼‰
          ALL_COMMITS=""
          COMMIT_COUNT=0
          
          for commit in $(git log --format="%H" --no-merges -10); do
            COMMIT_MSG=$(git log -1 --format="%s" $commit)
            
            # è·³è¿‡è‹±æ–‡updateæäº¤
            if [[ "$COMMIT_MSG" =~ ^(update|Update|UPDATE).* ]] && \
               [[ ! "$COMMIT_MSG" =~ [\u4e00-\u9fff] ]]; then
              continue
            fi
            
            COMMIT_DATE=$(git log -1 --format="%ad" --date=short $commit)
            COMMIT_AUTHOR=$(git log -1 --format="%an" $commit)
            
            ALL_COMMITS+="â€¢ $COMMIT_DATE $COMMIT_AUTHOR: $COMMIT_MSG"$'\n'
            COMMIT_COUNT=$((COMMIT_COUNT + 1))
            
            if [ $COMMIT_COUNT -ge 5 ]; then
              break
            fi
          done
          
          if [ -z "$ALL_COMMITS" ]; then
            ALL_COMMITS="â€¢ æš‚æ— æœ‰æ•ˆæäº¤è®°å½•"
          fi
          
          echo "all_commits<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ›´æ–°package.jsonç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if: hashFiles('package.json') == ''
        run: |
          if [ -f "package.json" ]; then
            npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version --allow-same-version
            echo "å·²æ›´æ–°package.jsonç‰ˆæœ¬"
          fi

      - name: åˆ›å»ºGitæ ‡ç­¾
        run: |
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "${{ steps.analyze-commits.outputs.commit_message }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: ç‰ˆæœ¬ v${{ steps.version.outputs.new_version }}
          body: |
            ## ğŸ“ æ›´æ–°å†…å®¹
            
            **${{ steps.analyze-commits.outputs.commit_message }}**
            
            ${{ steps.analyze-commits.outputs.commit_body }}
            
            ---
            
            ## ğŸ“‹ æœ€è¿‘æ›´æ–°è®°å½•
            
            ${{ steps.all_commits.outputs.all_commits }}
            
            ---
            
            ### ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯
            
            | é¡¹ç›® | å€¼ |
            |------|-----|
            | **ç‰ˆæœ¬å·** | v${{ steps.version.outputs.new_version }} |
            | **æ›´æ–°ç±»å‹** | ${{ steps.analyze-commits.outputs.version_bump }} |
            | **ä¸Šä¸€ä¸ªç‰ˆæœ¬** | v${{ steps.version.outputs.current_version }} |
            | **è‡ªåŠ¨å‘å¸ƒæ—¶é—´** | $(date '+%Y-%m-%d %H:%M:%S') |
            
            ---
            
            *ğŸ¤– æ­¤Releaseç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*  
            *ğŸ“Œ åŸºäºæäº¤: `${{ steps.analyze-commits.outputs.commit_hash }}`*
          draft: false
          prerelease: false
          generate_release_notes: false